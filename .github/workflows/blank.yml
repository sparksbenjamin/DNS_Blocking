name: Generate Service Blocklists

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  generate-blocklists:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Generate blocklists
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime

          # Fetch the services.json file
          url = "https://adguardteam.github.io/HostlistsRegistry/assets/services.json"
          response = requests.get(url)
          response.raise_for_status()
          services = response.json()

          # Create services directory
          os.makedirs("services", exist_ok=True)

          # Generate timestamp
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          # Process each service
          for service in services:
              service_id = service.get('id', 'unknown')
              service_name = service.get('name', 'Unknown Service')
              domains = service.get('domains', [])
              
              if not domains:
                  continue
              
              # Create filename (sanitize service_id for filename)
              filename = f"services/{service_id}.txt"
              
              # Write blocklist file
              with open(filename, 'w', encoding='utf-8') as f:
                  # Header compatible with both Pi-hole and AdGuard
                  f.write(f"# {service_name} Blocklist\n")
                  f.write(f"# Service ID: {service_id}\n")
                  f.write(f"# Generated: {timestamp}\n")
                  f.write(f"# Total domains: {len(domains)}\n")
                  f.write(f"#\n")
                  f.write(f"# Compatible with Pi-hole and AdGuard Home\n")
                  f.write(f"#\n\n")
                  
                  # Write domains (one per line, Pi-hole/AdGuard format)
                  for domain in sorted(domains):
                      f.write(f"{domain}\n")
              
              print(f"Generated {filename} with {len(domains)} domains")

          # Get repository info from environment
          repo = os.environ.get('GITHUB_REPOSITORY', 'YOUR_USERNAME/YOUR_REPO')
          
          # Create index/README
          with open("services/README.md", 'w', encoding='utf-8') as f:
              f.write(f"# Service Blocklists\n\n")
              f.write(f"Generated: {timestamp}\n\n")
              f.write(f"These blocklists are generated from the [AdGuard Hostlists Registry](https://adguardteam.github.io/HostlistsRegistry/assets/services.json).\n\n")
              f.write(f"## Available Blocklists\n\n")
              f.write(f"| Service | Domains | File | Raw URL |\n")
              f.write(f"|---------|---------|------|----------|\n")
              
              for service in sorted(services, key=lambda x: x.get('name', '')):
                  service_id = service.get('id', 'unknown')
                  service_name = service.get('name', 'Unknown')
                  domain_count = len(service.get('domains', []))
                  
                  if domain_count > 0:
                      raw_url = f"https://raw.githubusercontent.com/{repo}/main/services/{service_id}.txt"
                      f.write(f"| {service_name} | {domain_count} | [{service_id}.txt]({service_id}.txt) | [Raw]({raw_url}) |\n")
              
              f.write(f"\n## Usage\n\n")
              f.write(f"### Pi-hole\n")
              f.write(f"Add the raw GitHub URL to your blocklists in Pi-hole settings.\n\n")
              f.write(f"### AdGuard Home\n")
              f.write(f"Add the raw GitHub URL to your DNS blocklists in AdGuard Home settings.\n")

          print(f"\nTotal services processed: {len([s for s in services if s.get('domains')])}")
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add services/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update blocklists - $(date +'%Y-%m-%d %H:%M:%S UTC')" && git push)
